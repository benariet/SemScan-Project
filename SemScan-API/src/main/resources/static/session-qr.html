<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5B4FCF">
    <title>SemScan - Session QR</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/assets/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="css/main.css?v=13">
    <style>
        body {
            background: #F5F5F5;
            min-height: 100vh;
            margin: 0;
        }

        /* Content area */
        .content {
            padding: 8px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Slot date/title */
        .slot-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #212121;
            margin: 8px 0;
        }

        /* Instructions */
        .instructions {
            text-align: center;
            font-size: 14px;
            color: #757575;
            margin: 4px 0 8px 0;
        }

        /* QR Code container */
        .qr-container {
            margin: 8px 16px;
            background: white;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-container img {
            width: 100%;
            max-width: 300px;
            height: auto;
        }

        /* QR code generated by qrcodejs */
        #qrCodeDiv {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #qrCodeDiv img {
            width: 300px !important;
            height: 300px !important;
        }

        #qrCodeDiv canvas {
            display: none;
        }

        /* Session info card */
        .session-info-card {
            background: white;
            border-radius: 12px;
            margin: 24px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .session-info-content {
            padding: 16px;
        }

        .session-info-row {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #424242;
        }

        .session-info-row svg {
            width: 20px;
            height: 20px;
            fill: #757575;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .session-info-divider {
            height: 1px;
            background: #E0E0E0;
            margin: 12px 0;
        }

        .valid-until {
            color: #D32F2F;
            font-weight: bold;
        }

        .valid-until svg {
            fill: #D32F2F;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 16px;
            margin: 32px 16px;
        }

        .btn-action {
            flex: 1;
            height: 40px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .btn-cancel-session {
            background: white;
            color: #D32F2F;
            border: 2px solid #D32F2F;
        }

        .btn-cancel-session:hover {
            background: rgba(211, 47, 47, 0.1);
        }

        .btn-end-session {
            background: white;
            color: #007BFF;
            border: 2px solid #007BFF;
        }

        .btn-end-session:hover {
            background: rgba(0, 123, 255, 0.1);
        }

        /* Loading state */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }

        .loading-container .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #E0E0E0;
            border-top-color: #5B4FCF;
        }

        .loading-text {
            margin-top: 16px;
            color: #757575;
            font-size: 14px;
        }

        /* Error state */
        .error-container {
            text-align: center;
            padding: 40px 20px;
        }

        .error-icon {
            width: 64px;
            height: 64px;
            fill: #D32F2F;
            margin-bottom: 16px;
        }

        .error-message {
            color: #D32F2F;
            font-size: 16px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body style="display: none;">
    <!-- Side Menu Overlay -->
    <div class="side-menu-overlay" id="menuOverlay"></div>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3 id="menuUserName">User</h3>
            <p id="menuUserEmail">user@bgu.ac.il</p>
        </div>
        <div class="side-menu-items">
            <a href="settings.html" class="side-menu-item">
                <svg viewBox="0 0 24 24" width="24" height="24"><path d="M19.14,12.94c0.04-0.31,0.06-0.63,0.06-0.94c0-0.31-0.02-0.63-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.37,4.8,11.69,4.8,12s0.02,0.63,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
                <span>Settings</span>
            </a>
            <div class="side-menu-divider"></div>
            <a href="#" class="side-menu-item" id="logoutMenuItem">
                <svg viewBox="0 0 24 24" width="24" height="24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Header -->
    <header class="header header-with-nav">
        <button class="back-btn" onclick="window.location.href='presenter.html'">
            <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </button>
        <h1 class="header-title">Session QR</h1>
        <button class="menu-btn" id="menuBtn">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
    </header>

    <!-- Main Content -->
    <div class="content" id="mainContent" style="display: none;">
        <!-- Slot Title (Day + Date) -->
        <div class="slot-title" id="slotTitle">Wednesday &bull; 28/01/2026</div>

        <!-- Instructions -->
        <div class="instructions">Have participants scan this QR to mark attendance.</div>

        <!-- QR Code -->
        <div class="qr-container">
            <div id="qrCodeDiv"></div>
        </div>

        <!-- Session Info Card -->
        <div class="session-info-card">
            <div class="session-info-content">
                <div class="session-info-row">
                    <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                    <span id="openedAt">Opened at January 28, 2026 at 9:46 AM</span>
                </div>
                <div class="session-info-divider"></div>
                <div class="session-info-row valid-until">
                    <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                    <span id="validUntil">Valid until January 28, 2026 at 9:47 AM</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn-action btn-cancel-session" id="btnCancelSession">Cancel Session</button>
            <button class="btn-action btn-end-session" id="btnEndSession">End Session</button>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" id="loadingState">
        <div class="spinner"></div>
        <div class="loading-text">Opening attendance session...</div>
    </div>

    <!-- Error State -->
    <div class="error-container" id="errorState" style="display: none;">
        <svg class="error-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
        <div class="error-message" id="errorMessage">Failed to open session</div>
        <a href="presenter.html" class="btn btn-primary">Back to Dashboard</a>
    </div>

    <!-- Toast container -->
    <div class="toast-container"></div>

    <!-- QR Code generator library (qrcodejs - local with CDN fallback) -->
    <script src="lib/qrcode.min.js"></script>
    <script>
        // Fallback to CDN if local file failed to load (createElement avoids document.write page destruction)
        if (typeof QRCode === 'undefined') {
            var cdnScript = document.createElement('script');
            cdnScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
            document.head.appendChild(cdnScript);
        }
    </script>
    <script src="js/config.js?v=3"></script>
    <script src="js/utils.js?v=3"></script>
    <script src="js/api.js?v=3"></script>
    <script>
        // Require authentication
        if (!Utils.isLoggedIn()) {
            window.location.replace('index.html');
            throw new Error('Not authenticated');
        }

        document.body.style.display = '';

        const username = Utils.getUsername();
        const urlParams = new URLSearchParams(window.location.search);
        const slotId = urlParams.get('slotId');
        const slotDate = urlParams.get('date');
        const slotDay = urlParams.get('day');

        let sessionData = null;

        // Setup side menu
        function setupMenu() {
            const menuBtn = document.getElementById('menuBtn');
            const menuOverlay = document.getElementById('menuOverlay');
            const sideMenu = document.getElementById('sideMenu');
            const logoutMenuItem = document.getElementById('logoutMenuItem');

            document.getElementById('menuUserName').textContent = username;
            document.getElementById('menuUserEmail').textContent = username + '@bgu.ac.il';

            menuBtn.addEventListener('click', () => {
                sideMenu.classList.add('open');
                menuOverlay.classList.add('open');
            });

            menuOverlay.addEventListener('click', () => {
                sideMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
            });

            logoutMenuItem.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.clear();
                window.location.href = 'index.html';
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupMenu();
            if (!slotId) {
                showError('No slot ID provided');
                return;
            }

            // Set slot title if provided via URL params (textContent prevents XSS)
            if (slotDay && slotDate) {
                document.getElementById('slotTitle').textContent = `${decodeURIComponent(slotDay)} â€¢ ${decodeURIComponent(slotDate)}`;
            } else {
                // Hide slot title if no date info
                document.getElementById('slotTitle').style.display = 'none';
            }

            // Setup button handlers
            document.getElementById('btnCancelSession').addEventListener('click', cancelSession);
            document.getElementById('btnEndSession').addEventListener('click', endSession);

            // Open attendance session
            openSession();
        });

        async function openSession() {
            showLoading();
            try {
                const response = await API.openAttendance(username, slotId);
                sessionData = response;

                console.log('API Response:', response);

                // Generate QR code client-side using qrcodejs
                const qrCodeDiv = document.getElementById('qrCodeDiv');

                // Use qrPayload if available, otherwise construct attendance URL
                let qrData = response.qrPayload;
                if (!qrData && response.sessionId) {
                    // Construct attendance URL for participants to scan
                    qrData = `${window.location.origin}/api/v1/attendance/session/${response.sessionId}`;
                }

                if (qrData) {
                    try {
                        // Clear any existing QR code
                        qrCodeDiv.innerHTML = '';

                        // Generate QR code using qrcodejs library
                        new QRCode(qrCodeDiv, {
                            text: qrData,
                            width: 300,
                            height: 300,
                            colorDark: '#000000',
                            colorLight: '#FFFFFF',
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        console.log('QR code generated for:', qrData);
                    } catch (qrError) {
                        console.error('Failed to generate QR code:', qrError);
                        qrCodeDiv.innerHTML = '<p style="color: #D32F2F;">Failed to generate QR code</p>';
                    }
                } else {
                    console.warn('No QR data available in response:', response);
                    qrCodeDiv.innerHTML = '<p style="color: #757575;">QR Code not available</p>';
                }

                // Format and display timestamps
                if (response.openedAt) {
                    const openedDate = new Date(response.openedAt);
                    document.getElementById('openedAt').textContent = `Opened at ${formatDateTime(openedDate)}`;
                }
                if (response.closesAt) {
                    const closesDate = new Date(response.closesAt);
                    document.getElementById('validUntil').textContent = `Valid until ${formatDateTime(closesDate)}`;
                    // Start auto-close timer based on server's closesAt
                    startAutoCloseTimer(closesDate.getTime());
                }

                showContent();

            } catch (error) {
                console.error('Failed to open session:', error);
                showError(error.message || 'Failed to open attendance session');
            }
        }

        function formatDateTime(date) {
            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            return date.toLocaleDateString('en-US', options).replace(',', ' at');
        }

        async function cancelSession() {
            if (!confirm('Are you sure you want to cancel this session? This will discard all attendance records.')) {
                return;
            }

            if (!sessionData || !sessionData.sessionId) {
                Utils.showToast('No active session to cancel', 'error');
                return;
            }

            Utils.showLoading();
            try {
                // Delete the session (cancels and removes attendance records)
                await API.delete(`/sessions/${sessionData.sessionId}`);
                Utils.showToast('Session cancelled', 'info');
                // Navigate to summary page with canceled status
                navigateToSummary('canceled', 0);
            } catch (error) {
                Utils.hideLoading();
                Utils.showToast('Failed to cancel session: ' + error.message, 'error');
            }
        }

        async function endSession() {
            if (!sessionData || !sessionData.sessionId) {
                Utils.showToast('No active session to end', 'error');
                return;
            }

            Utils.showLoading();
            try {
                // Close the session using PUT /sessions/{sessionId}/close
                await API.request(`/sessions/${sessionData.sessionId}/close`, { method: 'PUT' });

                // Try to get attendance count
                let attendeeCount = 0;
                try {
                    const attendanceData = await API.get(`/attendance/session/${sessionData.sessionId}`);
                    if (Array.isArray(attendanceData)) {
                        attendeeCount = attendanceData.length;
                    } else if (attendanceData && typeof attendanceData === 'object') {
                        // Handle wrapped response
                        if (Array.isArray(attendanceData.data)) {
                            attendeeCount = attendanceData.data.length;
                        } else if (typeof attendanceData.count === 'number') {
                            attendeeCount = attendanceData.count;
                        }
                    }
                    console.log('Attendance data:', attendanceData, 'Count:', attendeeCount);
                } catch (e) {
                    console.log('Could not fetch attendance count:', e);
                }

                // Upload export report (sends email)
                try {
                    const uploadResult = await API.post(`/export/upload?sessionId=${sessionData.sessionId}&format=xlsx`, {});
                    console.log('Export upload result:', uploadResult);
                    if (uploadResult && uploadResult.records) {
                        attendeeCount = uploadResult.records;
                    }
                } catch (e) {
                    console.log('Could not upload export:', e);
                    // Continue anyway - report upload is not critical
                }

                Utils.showToast('Session ended successfully', 'success');
                // Navigate to summary page
                navigateToSummary('closed', attendeeCount);
            } catch (error) {
                Utils.hideLoading();
                // Check if it's a network/server error
                if (error.message && (error.message.includes('fetch') || error.message.includes('network') || error.message.includes('Failed to fetch'))) {
                    showError('Server is temporarily unavailable (may be restarting). Please wait a moment and try again.');
                } else {
                    Utils.showToast('Failed to end session: ' + error.message, 'error');
                }
            }
        }

        function navigateToSummary(status, attendees) {
            const params = new URLSearchParams();
            params.set('status', status);
            params.set('attendees', attendees.toString());

            // Pass session times
            if (sessionData) {
                if (sessionData.openedAt) {
                    params.set('openedAt', sessionData.openedAt);
                }
                params.set('closedAt', new Date().toISOString());
            }

            // Pass slot info from URL params
            if (slotDay) {
                params.set('day', slotDay);
            }
            if (slotDate) {
                params.set('date', slotDate);
            }

            window.location.href = `session-summary.html?${params.toString()}`;
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
        }

        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            // Format any ISO dates in the message
            const formattedMessage = formatDatesInMessage(message);
            document.getElementById('errorMessage').textContent = formattedMessage;
        }

        // Auto-close timer - checks every 10 seconds if session has expired
        let autoCloseTimerId = null;
        let isAutoClosing = false;

        function startAutoCloseTimer(closesAtMs) {
            if (autoCloseTimerId) clearInterval(autoCloseTimerId);

            autoCloseTimerId = setInterval(() => {
                if (isAutoClosing) return;
                const now = Date.now();
                if (now >= closesAtMs) {
                    console.log('[AUTO_CLOSE] Session expired, auto-closing...');
                    isAutoClosing = true;
                    clearInterval(autoCloseTimerId);
                    autoCloseSession();
                }
            }, 10000); // Check every 10 seconds

            // Also check immediately in case already expired
            if (Date.now() >= closesAtMs) {
                console.log('[AUTO_CLOSE] Session already expired, closing now...');
                isAutoClosing = true;
                clearInterval(autoCloseTimerId);
                autoCloseSession();
            }
        }

        async function autoCloseSession() {
            if (!sessionData || !sessionData.sessionId) return;

            let attendeeCount = 0;
            let closeSucceeded = false;

            try {
                // Close the session
                await API.request(`/sessions/${sessionData.sessionId}/close`, { method: 'PUT' });
                console.log('[AUTO_CLOSE] Session closed via API');
                closeSucceeded = true;

                // Get attendance count
                try {
                    const attendanceData = await API.get(`/attendance/session/${sessionData.sessionId}`);
                    if (Array.isArray(attendanceData)) {
                        attendeeCount = attendanceData.length;
                    } else if (attendanceData && Array.isArray(attendanceData.data)) {
                        attendeeCount = attendanceData.data.length;
                    } else if (attendanceData && typeof attendanceData.count === 'number') {
                        attendeeCount = attendanceData.count;
                    }
                } catch (e) {
                    console.log('[AUTO_CLOSE] Could not fetch attendance count:', e);
                }

                // Upload export report (sends email)
                try {
                    const uploadResult = await API.post(`/export/upload?sessionId=${sessionData.sessionId}&format=xlsx`, {});
                    console.log('[AUTO_CLOSE] Export upload result:', uploadResult);
                    if (uploadResult && uploadResult.records) {
                        attendeeCount = uploadResult.records;
                    }
                } catch (e) {
                    console.log('[AUTO_CLOSE] Could not upload export:', e);
                }
            } catch (error) {
                console.error('[AUTO_CLOSE] Failed to auto-close session:', error);
                // Show error to user instead of silently navigating
                Utils.showToast('Session expired. Server may be temporarily unavailable. The session will be closed automatically.', 'error');
            }

            // Check if server is available before navigating
            const serverAvailable = await checkServerAvailable();
            if (serverAvailable) {
                navigateToSummary('closed', attendeeCount);
            } else {
                // Server is down - show error instead of navigating to 502 page
                showError('Session expired. Server is temporarily unavailable (may be restarting). Please wait a moment and go back to the dashboard.');
            }
        }

        // Check if server is responding
        async function checkServerAvailable() {
            try {
                const response = await fetch('/api/v1/health', { method: 'GET', cache: 'no-store' });
                return response.ok;
            } catch (e) {
                // Also try a simple static file
                try {
                    const response = await fetch('/index.html', { method: 'HEAD', cache: 'no-store' });
                    return response.ok;
                } catch (e2) {
                    return false;
                }
            }
        }

        function formatDatesInMessage(message) {
            // Match ISO date patterns like 2026-01-28T10:05:57
            const isoDateRegex = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?/g;
            return message.replace(isoDateRegex, (match) => {
                const date = new Date(match);
                if (!isNaN(date.getTime())) {
                    return formatDateTime(date);
                }
                return match;
            });
        }
    </script>
</body>
</html>
