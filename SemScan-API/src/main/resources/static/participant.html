<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#5B4FCF">
    <title>SemScan - Participant</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="apple-touch-icon" href="/assets/logo.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="css/main.css?v=13">
</head>
<body style="display: none;">
    <!-- Side Menu Overlay -->
    <div class="side-menu-overlay" id="menuOverlay"></div>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3 id="menuUserName">User</h3>
            <p id="menuUserEmail">user@bgu.ac.il</p>
        </div>
        <div class="side-menu-items">
            <a href="settings.html" class="side-menu-item">
                <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                <span>Settings</span>
            </a>
            <div class="side-menu-divider"></div>
            <a href="#" class="side-menu-item" id="logoutMenuItem">
                <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                <span>Logout</span>
            </a>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <button class="menu-btn" id="menuBtn">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <h1 class="header-title">Participant Home</h1>
    </header>

    <div class="container">
        <!-- Scan Attendance Card -->
        <div class="action-card" id="cardScanAttendance" style="cursor: pointer;">
            <div class="action-card-icon">
                <svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6 8h1.5v1.5H13V13zm1.5 1.5H16V16h-1.5v-1.5zM16 13h1.5v1.5H16V13zm-3 3h1.5v1.5H13V16zm1.5 1.5H16V19h-1.5v-1.5zM16 16h1.5v1.5H16V16zm1.5-1.5H19V16h-1.5v-1.5zm0 3H19V19h-1.5v-1.5zM19 16h1.5v1.5H19V16z"/></svg>
            </div>
            <div class="action-card-text">Scan Attendance QR</div>
            <svg class="action-card-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </div>

        <!-- Manual Attendance Request Card (hidden by default, shown if enabled in config) -->
        <a href="manual-attendance.html" class="action-card" id="manualAttendanceCard" style="display: none;">
            <div class="action-card-icon">
                <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </div>
            <div class="action-card-text">Manual Attendance Request</div>
            <svg class="action-card-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </a>

        <!-- Attendance History Card -->
        <div class="action-card" id="historyCard" style="cursor: pointer;">
            <div class="action-card-icon">
                <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
            </div>
            <div class="action-card-text">Attendance History</div>
            <svg class="action-card-arrow" id="historyArrow" viewBox="0 0 24 24" style="transition: transform 0.3s;"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </div>

        <!-- Attendance History Section (hidden by default) -->
        <div id="historySection" style="display: none; margin-top: 16px;">
            <div id="historyLoading" style="text-align: center; padding: 20px; color: #666;">
                <div class="spinner" style="margin: 0 auto 10px;"></div>
                Loading attendance history...
            </div>
            <div id="historyEmpty" style="display: none; text-align: center; padding: 30px; color: #888; background: white; border-radius: 16px;">
                <svg viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: #ccc; margin-bottom: 10px;"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                <p>No attendance records found</p>
            </div>
            <div id="historyList"></div>
            <div id="historyTotal" style="display: none; text-align: center; padding: 12px; background: rgba(255,107,53,0.1); border-radius: 12px; margin-top: 12px; font-weight: 600; color: #FF6B35;"></div>
        </div>

        <div style="height: 60px;"></div>

        <!-- Change Role Card -->
        <a href="presenter.html" class="action-card blue">
            <div class="action-card-icon">
                <svg viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
            </div>
            <div class="action-card-text">Switch to Presenter Mode</div>
            <svg class="action-card-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
        </a>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Toast container -->
    <div class="toast-container"></div>

    <script src="js/config.js?v=101"></script>
    <script src="js/utils.js?v=101"></script>
    <script src="js/api.js?v=101"></script>
    <script>
        // Require authentication FIRST - block page until verified
        if (!Utils.isLoggedIn()) {
            window.location.replace('index.html');
            throw new Error('Not authenticated');
        }

        // COPY FROM ANDROID: Check hasCompletedInitialSetup()
        // If setup not completed, redirect to first-time setup page
        if (localStorage.getItem('setup_completed') !== 'true') {
            Logger.info('AUTH_CHECK', 'Setup not completed, redirecting to first-time-setup.html');
            window.location.replace('first-time-setup.html');
            throw new Error('Setup not completed');
        }

        // Show page only after auth verified
        document.body.style.display = '';

        const username = Utils.getUsername();

        let historyExpanded = false;
        let historyLoaded = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Setup menu
            setupMenu();

            // Setup scan attendance card click - check for open sessions first (COPY FROM ANDROID)
            document.getElementById('cardScanAttendance').addEventListener('click', openQRScanner);

            // Setup history card toggle
            document.getElementById('historyCard').addEventListener('click', toggleHistory);

            // Check if manual attendance is enabled
            checkManualAttendanceEnabled();
        });

        // COPY FROM ANDROID: Check for open sessions before allowing QR scanner
        async function openQRScanner() {
            Logger.userAction('Scan Attendance clicked', 'Checking for open sessions');
            Utils.showLoading();

            try {
                const sessions = await API.get('/sessions/open');
                Utils.hideLoading();

                // Filter to only OPEN sessions (same as Android)
                const openSessions = (sessions || []).filter(s =>
                    s && s.status && s.status.toUpperCase() === 'OPEN'
                );

                Logger.info('QR_SCAN', `Found ${openSessions.length} open sessions`);

                if (openSessions.length === 0) {
                    // No open sessions - show error (same as Android showNoSessionsError)
                    Logger.warn('QR_SCAN', 'No open sessions - blocking scanner');
                    showNoSessionsError();
                } else {
                    // Open sessions available - proceed to scanner
                    Logger.info('QR_SCAN', 'Open sessions available - opening scanner');
                    window.location.href = 'scanner.html';
                }
            } catch (error) {
                Utils.hideLoading();
                Logger.error('QR_SCAN', 'Failed to check for open sessions', error);
                // On error, show no sessions error (same as Android - don't allow scanner without verification)
                showNoSessionsError();
            }
        }

        function showNoSessionsError() {
            // Same message as Android app
            alert('No Active Sessions\n\nThere are no active sessions available right now. Please wait for a presenter to open a session before scanning a QR code.');
        }

        function setupMenu() {
            const menuBtn = document.getElementById('menuBtn');
            const menuOverlay = document.getElementById('menuOverlay');
            const sideMenu = document.getElementById('sideMenu');
            const logoutMenuItem = document.getElementById('logoutMenuItem');

            // Populate user info in menu
            const userData = Utils.getUserData();
            const menuUserName = document.getElementById('menuUserName');
            const menuUserEmail = document.getElementById('menuUserEmail');

            if (userData?.firstName && userData?.lastName) {
                menuUserName.textContent = `${userData.firstName} ${userData.lastName}`;
            } else if (userData?.firstName) {
                menuUserName.textContent = userData.firstName;
            } else {
                menuUserName.textContent = username;
            }
            menuUserEmail.textContent = `${username}@bgu.ac.il`;

            // Toggle menu
            menuBtn.addEventListener('click', () => {
                sideMenu.classList.add('open');
                menuOverlay.classList.add('open');
            });

            // Close menu on overlay click
            menuOverlay.addEventListener('click', () => {
                sideMenu.classList.remove('open');
                menuOverlay.classList.remove('open');
            });

            // Logout from menu
            logoutMenuItem.addEventListener('click', (e) => {
                e.preventDefault();
                Utils.logout();
            });
        }

        async function checkManualAttendanceEnabled() {
            try {
                const config = await API.get('/config/mobile');
                if (config && config.manualAttendanceEnabled) {
                    document.getElementById('manualAttendanceCard').style.display = '';
                }
            } catch (error) {
                console.warn('Failed to fetch config:', error);
                // Keep hidden if config fetch fails
            }
        }

        function toggleHistory() {
            historyExpanded = !historyExpanded;
            const section = document.getElementById('historySection');
            const arrow = document.getElementById('historyArrow');

            if (historyExpanded) {
                section.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
                if (!historyLoaded) {
                    loadAttendanceHistory();
                }
            } else {
                section.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        async function loadAttendanceHistory() {
            const loading = document.getElementById('historyLoading');
            const empty = document.getElementById('historyEmpty');
            const list = document.getElementById('historyList');
            const total = document.getElementById('historyTotal');

            loading.style.display = 'block';
            empty.style.display = 'none';
            list.innerHTML = '';
            total.style.display = 'none';

            try {
                const response = await API.get(`/attendance/student/${username}`);
                historyLoaded = true;
                loading.style.display = 'none';

                if (!response || response.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                // Sort by date (most recent first)
                response.sort((a, b) => new Date(b.attendanceTime) - new Date(a.attendanceTime));

                // Render attendance records
                response.forEach(record => {
                    const card = createHistoryCard(record);
                    list.appendChild(card);
                });

                // Show total
                total.textContent = `Total: ${response.length} session${response.length !== 1 ? 's' : ''} attended`;
                total.style.display = 'block';

            } catch (error) {
                console.error('Failed to load attendance history:', error);
                loading.style.display = 'none';
                empty.innerHTML = '<p style="color: #e74c3c;">Failed to load attendance history</p>';
                empty.style.display = 'block';
            }
        }

        function createHistoryCard(record) {
            const div = document.createElement('div');
            div.style.cssText = 'background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);';

            const date = new Date(record.attendanceTime);
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const methodIcon = record.method === 'QR_SCAN' ?
                '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:#4CAF50;"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>' :
                '<svg viewBox="0 0 24 24" style="width:20px;height:20px;fill:#FF9800;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>';

            const methodText = record.method === 'QR_SCAN' ? 'QR Scan' :
                               record.method === 'MANUAL_REQUEST' ? 'Manual Request' :
                               record.method === 'MANUAL' ? 'Manual' : record.method;

            // Escape user data to prevent XSS
            const safeTopic = record.topic ? Utils.escapeHtml(record.topic) : '';
            const safePresenter = record.presenter ? Utils.escapeHtml(record.presenter) : '';

            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-weight: 600; color: #333; margin-bottom: 4px;">${dateStr}</div>
                        <div style="color: #666; font-size: 14px;">${timeStr}</div>
                        ${safeTopic ? `<div style="color: #888; font-size: 13px; margin-top: 6px;">${safeTopic}</div>` : ''}
                        ${safePresenter ? `<div style="color: #888; font-size: 13px;">Presenter: ${safePresenter}</div>` : ''}
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px; background: #f5f5f5; padding: 6px 10px; border-radius: 20px;">
                        ${methodIcon}
                        <span style="font-size: 12px; color: #666;">${methodText}</span>
                    </div>
                </div>
            `;

            return div;
        }
    </script>
</body>
</html>
